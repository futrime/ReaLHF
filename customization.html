

<!DOCTYPE html>
<html class="no-js" lang="en">
  <head>
    <meta charset="utf-8" />
      <meta name="viewport" content="width=device-width, initial-scale=1" />

    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="docsearch:name" content="ReaL" />
    <meta name="docsearch:package_type" content="" />
    <meta name="docsearch:release" content="0.1.0" />
    <meta name="docsearch:version" content="" />
    
      <title>Customization &mdash; ReaL 0.1.0 documentation</title>
    
    <link rel="stylesheet" href="_static/bootstrap-icons.css" type="text/css" />
          <!-- add (1) pathto "_CascadingStyleSheet('_static/pygments.css', priority=200, rel='stylesheet', type='text/css')" -->
          <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=83e35b93" />
          <!-- add (1) pathto "_CascadingStyleSheet('_static/custom.css', priority=500, rel='stylesheet', type='text/css')" -->
          <link rel="stylesheet" type="text/css" href="_static/custom.css?v=97da1bf0" />
          <!-- add (1) pathto "_CascadingStyleSheet('_static/pygments_dark.css', priority=500, rel='stylesheet', type='text/css', media='(prefers-color-scheme: dark)', id='pygments_dark_css')" -->
          <link id="pygments_dark_css" media="(prefers-color-scheme: dark)" rel="stylesheet" type="text/css" href="_static/pygments_dark.css?v=b20cc3f5" />
          <!-- add (1) pathto "_CascadingStyleSheet('_static/colorsets/sphinx-nefertiti-default-0.3.4.min.css', priority=500, rel='stylesheet', type='text/css')" -->
          <link rel="stylesheet" type="text/css" href="_static/colorsets/sphinx-nefertiti-default-0.3.4.min.css" />
          <!-- add (1) pathto "_CascadingStyleSheet('_static/fonts/nunito/stylesheet.css', priority=500, rel='stylesheet', type='text/css')" -->
          <link rel="stylesheet" type="text/css" href="_static/fonts/nunito/stylesheet.css" />
          <!-- add (1) pathto "_CascadingStyleSheet('_static/fonts/red-hat-mono/stylesheet.css', priority=500, rel='stylesheet', type='text/css')" -->
          <link rel="stylesheet" type="text/css" href="_static/fonts/red-hat-mono/stylesheet.css" />
        <link rel="index" title="Index" href="genindex.html" />
        <link rel="search" title="Search" href="search.html" />
        <link rel="top" title="ReaL 0.1.0 documentation" href="#" />
        <link rel="next" title="Set Up Distributed Experiments" href="distributed.html" />
        <link rel="prev" title="Quickstart" href="quickstart.html" />
    <style>
      :root {
        --nftt-body-font-family: "Nunito", var(--nftt-font-sans-serif) !important;
        --nftt-font-monospace: "Red Hat Mono", var(--nftt-font-family-monospace) !important;
        --nftt-project-name-font: var(--nftt-body-font-family);
        --nftt-documentation-font: var(--nftt-body-font-family);
        --nftt-doc-headers-font: "Georgia", var(--nftt-documentation-font);}
      h1 *, h2 *, h3 *, h4 *, h5 *, h6 * { font-size: inherit; }
    </style>
  </head>
  <body>
    <header class="navbar navbar-expand-xl navbar-dark nftt-navbar flex-column fixed-top">
      <div class="skip-links container-fluid visually-hidden-focusable overflow-hidden justify-content-start flex-grow-1">
        <div class="border-bottom mb-2 pb-2 w-100">
          <a class="d-none d-md-inline-flex p-2 m-1" href="#sidebar-filter">Skip to docs navigation</a>
          <a class="d-inline-flex p-2 m-1" href="#content">Skip to main content</a>
        </div>
      </div>
      <nav class="container-xxl nftt-gutter flex-wrap flex-xl-nowrap" aria-label="Main navigation">
        <div class="nftt-navbar-toggler">
          <button class="navbar-toggler p-2" type="button" data-bs-toggle="offcanvas" data-bs-target="#sidebar" aria-controls="sidebar" aria-label="Toggle documentation navigation">
            <i class="bi bi-list"></i>
          </button>
        </div>
          <a href="index.html"
              
              class="navbar-brand p-0 me-0 md-lg-2"
          ><span class="brand-text">ReaL</span></a>
        
        <div class="d-flex d-xl-none">
          <button class="navbar-toggler p-2" type="button" data-bs-toggle="offcanvas" data-bs-target="#nfttSearch" aria-controls="nfttSearch" aria-label="Search">
            <i class="bi bi-search"></i>
          </button>
          <button class="navbar-toggler p-2" type="button" data-bs-toggle="offcanvas" data-bs-target="#nfttNavbar" aria-controls="nfttNavbar" aria-label="Toggle navigation">
            <i class="bi bi-three-dots"></i>
          </button>
        </div>
        
<div class="offcanvas-xl offcanvas-end flex-grow-1" tabindex="-1" id="nfttSearch" aria-labelledby="nfttSearchOffcanvasLabel" data-bs-scroll="true">
  <div class="offcanvas-header px-4 pb-0">
    <h5 class="offcanvas-title fw-bold" id="nfttSearchOffcanvasLabel">Search the documentation</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close" data-bs-target="#nfttSearch"></button>
  </div>
  <div class="offcanvas-body p-4 pt-0 p-xl-0 px-xl-3">
    <hr class="d-xl-none text-white-50">
    <ul class="navbar-nav flex-row align-items-center flex-wrap ms-md-auto">
      <li class="nav-item col-12 col-xl-auto">
        <form id="nftt-search-form" action="search.html" method="get">
          <div class="input-group">
            <input type="text" name="q" class="form-control" placeholder="Search docs" aria-label="Search" aria-describedby="button-search">
            <input type="hidden" name="check_keywords" value="yes" />
            <input type="hidden" name="area" value="default" />
            <button class="btn btn-primary" type="submit" id="button-search" aria-label="Search"><i class="bi bi-search"></i></button>
          </div>
        </form>
      </li>
    </ul>
  </div>
</div>

        <div class="offcanvas-xl offcanvas-end" tabindex="-1" id="nfttNavbar" aria-labelledby="nfttNavbarOffcanvasLabel" data-bs-scroll="true">
          <div class="offcanvas-header px-4 pb-0">
            <div class="offcanvas-title navbar-brand" id="nfttNavbarOffcanvasLabel"><span class="brand-text">Nefertiti for Sphinx</span></div>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Close" data-bs-target="#nfttNavbar"></button>
          </div>
          <div class="offcanvas-body p-4 pt-0 p-xl-0 px-xl-3">
            <hr class="d-xl-none text-white-50">
            <ul class="navbar-nav flex-row align-items-center flex-wrap ms-lg-auto">
              
              <!-- version_dropdown.html -->

              
              <!-- colorscheme_dropdown.html -->
<li class="nav-item dropdown">
  <a class="nav-link d-flex py-2 px-0 px-xl-2 dropdown-toggle align-items-center" id="snftt-luz" href="#" data-bs-toggle="dropdown" data-bs-display="static" aria-expanded="false" aria-label="Toggle light/dark">
    <i class="bi bi-circle-half" data-snftt-luz-icon-active></i>
    <span id="snftt-luz-text" class="d-xl-none small ms-2">Toggle light/dark</span>
  </a>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="snftt-luz-text">
    <li>
      <h6 class="dropdown-header">Light/dark</h6>
    </li>
    <li>
      <a class="dropdown-item d-flex align-items-center" data-snftt-luz="light" href="#" aria-pressed="false">
        <span class="small">
          <i class="bi bi-sun" data-snftt-luz-icon="light"></i>
        </span>
        <span class="small ms-3">Light</span>
        <i class="bi bi-check ms-auto"></i>
      </a>
    </li>
    <li>
      <a class="dropdown-item d-flex align-items-center" data-snftt-luz="dark" href="#" aria-pressed="false">
        <span class="small">
          <i class="bi bi-moon-stars" data-snftt-luz-icon="dark"></i>
        </span>
        <span class="small ms-3">Dark</span>
        <i class="bi bi-check ms-auto"></i>
      </a>
    </li>
    <li>
      <a class="dropdown-item current d-flex align-items-center" data-snftt-luz="default" href="#" aria-pressed="false">
        <span class="small">
          <i class="bi bi-circle-half" data-snftt-luz-icon="default"></i>
        </span>
        <span class="small ms-3">Default</span>
        <i class="bi bi-check ms-auto"></i>
      </a>
    </li>
  </ul>
</li>
            </ul>
          </div>
        </div>
      </nav>
    </header>

    <div class="container-fluid flex-grow-1">
      <div class="nftt-gutter nftt-page">
        <aside class="nftt-sidebar ">
          <div class="nftt-sidebar-content">
            
            <div class="title d-none d-xl-block">
              <i class="bi bi-book"></i>&nbsp;&nbsp;<span>Index</span>
            </div>
            <div id="sidebar" tabindex="-1" class="offcanvas-xl offcanvas-start" aria-labelledby="nfttSidebarOffcanvasLabel">
                <!-- danirus sidebartemplate: "globaltoc.html" --><div class="offcanvas-header border-bottom">
  <h5 class="offcanvas-title fw-bold" id="nfttSidebarOffcanvasLabel">
    Table of contents
  </h5>
  <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close" data-bs-target="#sidebar"></button>
</div>

<div class="offcanvas-body">
  <nav class="toc" aria-label="Main menu">
    <div class="mb-3 p-1 pt-3 pb-4 border-bottom">
      <input id="sidebar-filter" type="text" name="filter" class="form-control form-control-sm" placeholder="filter" aria-label="filter">
    </div>
    <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="expconfig.html">Configurations</a></li>
<li class="toctree-l1"><a class="reference internal" href="quickstart.html">Quickstart</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Customization</a></li>
<li class="toctree-l1"><a class="reference internal" href="distributed.html">Set Up Distributed Experiments</a></li>
<li class="toctree-l1"><a class="reference internal" href="contributing.html">Contributing</a></li>
</ul>

  </nav>
  <template data-toggle-item-template>
    <button class="btn btn-sm btn-link toctree-expand" type="button">
      <i class="bi bi-caret-right"></i>
      <span class="visually-hidden">Toggle menu contents</span>
    </button>
  </template>
</div>
            </div>
            
          </div>
        </aside>
        <article id="content" class="nftt-content" role="main">
    <section id="customization">
<h1>Customization<a class="headerlink" href="#customization" title="Link to this heading">¶</a></h1>
<section id="customizing-datasets">
<h2>Customizing Datasets<a class="headerlink" href="#customizing-datasets" title="Link to this heading">¶</a></h2>
<section id="overview">
<h3>Overview<a class="headerlink" href="#overview" title="Link to this heading">¶</a></h3>
<p>We provide three types of dataset implementations in <code class="docutils literal notranslate"><span class="pre">realhf/impl/dataset/</span></code> with the following configurations:</p>
<ul class="simple">
<li><p><a class="reference internal" href="expconfig.html#realhf.PromptAnswerDatasetConfig" title="realhf.PromptAnswerDatasetConfig"><code class="xref py py-class docutils literal notranslate"><span class="pre">realhf.PromptAnswerDatasetConfig</span></code></a></p></li>
<li><p><a class="reference internal" href="expconfig.html#realhf.PairedComparisonDatasetConfig" title="realhf.PairedComparisonDatasetConfig"><code class="xref py py-class docutils literal notranslate"><span class="pre">realhf.PairedComparisonDatasetConfig</span></code></a></p></li>
<li><p><a class="reference internal" href="expconfig.html#realhf.PromptOnlyDatasetConfig" title="realhf.PromptOnlyDatasetConfig"><code class="xref py py-class docutils literal notranslate"><span class="pre">realhf.PromptOnlyDatasetConfig</span></code></a></p></li>
</ul>
<p>Please refer to the respective configuration documentation for detailed instructions on how to use or modify these datasets.</p>
<p>Datasets in ReaL are commonly used
<a class="reference external" href="https://pytorch.org/docs/stable/data.html#map-style-datasets">PyTorch map-style datasets</a>.
Users need to implement a <code class="docutils literal notranslate"><span class="pre">__getitem__</span></code> method in the dataset class,
which returns a <code class="xref py py-class docutils literal notranslate"><span class="pre">realhf.NamedArray</span></code> object containing the data of a single sample and its sequence length.
The sequence length is necessary because ReaL uses variable-length inputs without padding to save GPU memory.</p>
</section>
<section id="how-dataset-configuration-is-parsed">
<h3>How Dataset Configuration is Parsed<a class="headerlink" href="#how-dataset-configuration-is-parsed" title="Link to this heading">¶</a></h3>
<p>We will use the SFT experiment as an example.</p>
<p>The <a class="reference internal" href="expconfig.html#realhf.PromptAnswerDatasetConfig" title="realhf.PromptAnswerDatasetConfig"><code class="xref py py-class docutils literal notranslate"><span class="pre">realhf.PromptAnswerDatasetConfig</span></code></a> object will be converted to a dataset configuration
under the system API, specifically <code class="docutils literal notranslate"><span class="pre">realhf.api.core.system_api.Dataset</span></code>.
Refer to the <code class="docutils literal notranslate"><span class="pre">datasets</span></code> method of <a class="reference internal" href="expconfig.html#realhf.SFTConfig" title="realhf.SFTConfig"><code class="xref py py-class docutils literal notranslate"><span class="pre">realhf.SFTConfig</span></code></a> for more details.
This object includes a dataset name (in this case, “prompt_answer”) and corresponding arguments
that are passed to the dataset class’s constructor:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@property</span>
<span class="k">def</span> <span class="nf">datasets</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span>
        <span class="n">Dataset</span><span class="p">(</span>
            <span class="s2">&quot;prompt_answer&quot;</span><span class="p">,</span>
            <span class="n">args</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">max_length</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">max_seqlen</span><span class="p">,</span>
                <span class="n">dataset_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">train_path</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>
    <span class="p">]</span>
</pre></div>
</div>
<p>At the end of <code class="docutils literal notranslate"><span class="pre">realhf.impl.dataset.prompt_answer_dataset</span></code>, we find the following line:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">data_api</span><span class="o">.</span><span class="n">register_dataset</span><span class="p">(</span><span class="s2">&quot;prompt_answer&quot;</span><span class="p">,</span> <span class="n">PromptAnswerDataset</span><span class="p">)</span>
</pre></div>
</div>
<p>This line registers the dataset class with the system API. When this name is provided to the system API,
ReaL can locate this dataset implementation and construct it.
The <code class="docutils literal notranslate"><span class="pre">args</span></code> field in <code class="docutils literal notranslate"><span class="pre">realhf.api.core.system_api.Dataset</span></code> will be passed to the <code class="docutils literal notranslate"><span class="pre">__init__</span></code>
method of the dataset class, except that ReaL reserves a <code class="docutils literal notranslate"><span class="pre">util</span></code> field to store some utility objects.</p>
</section>
<section id="steps-for-implementing-a-new-dataset">
<h3>Steps for Implementing a New Dataset<a class="headerlink" href="#steps-for-implementing-a-new-dataset" title="Link to this heading">¶</a></h3>
<ol class="arabic simple">
<li><p>Create a new dataset file under <code class="docutils literal notranslate"><span class="pre">realhf/impl/dataset/</span></code>.</p></li>
<li><p>Implement a map-style PyTorch dataset class with a <code class="docutils literal notranslate"><span class="pre">__getitem__</span></code> method. This method should return a <code class="xref py py-class docutils literal notranslate"><span class="pre">realhf.NamedArray</span></code> object containing the sequence length as metadata.</p></li>
<li><p>Register the class with <code class="docutils literal notranslate"><span class="pre">data_api.register_dataset</span></code> at the end of the file, using the name “my-dataset”.</p></li>
<li><p>Update the name of the dataset in experiment configurations, for example, in the <code class="docutils literal notranslate"><span class="pre">datasets</span></code> method of <code class="docutils literal notranslate"><span class="pre">realhf.SFTConfig</span></code>, to “my-dataset”.</p></li>
<li><p>If you need to pass additional arguments to construct the dataset class, modify the quickstart configuration class (in this case, <code class="docutils literal notranslate"><span class="pre">realhf.PromptAnswerDatasetConfig</span></code>) as well as the <code class="docutils literal notranslate"><span class="pre">args</span></code> field in the system API dataset object.</p></li>
</ol>
</section>
</section>
<section id="customizing-models">
<h2>Customizing Models<a class="headerlink" href="#customizing-models" title="Link to this heading">¶</a></h2>
<section id="id1">
<h3>Overview<a class="headerlink" href="#id1" title="Link to this heading">¶</a></h3>
<p>For efficiency reasons, ReaL does not support every transformer
model from the HuggingFace model hub.
In ReaL, we implement the <a class="reference internal" href="expconfig.html#realhf.impl.model.nn.real_llm_api.ReaLModel" title="realhf.impl.model.nn.real_llm_api.ReaLModel"><code class="xref py py-class docutils literal notranslate"><span class="pre">realhf.impl.model.nn.real_llm_api.ReaLModel</span></code></a>
class that wraps the HuggingFace model and provides micro-batched pipelining,
offload, and parameter reallocation functionalities.</p>
<p>There are helper functions in the model API used to convert HuggingFace models back and forth,
such as <code class="docutils literal notranslate"><span class="pre">from_llama</span></code> and <code class="docutils literal notranslate"><span class="pre">to_llama</span></code>.
These helper functions are generated automatically by registering conversion functions in the <code class="docutils literal notranslate"><span class="pre">api/from_hf/</span></code> folder.</p>
<p>For example, consider <code class="docutils literal notranslate"><span class="pre">api/from_hf/llama.py</span></code>.
To register a convertible HuggingFace model, the user should implement:</p>
<ul class="simple">
<li><p>Two functions to convert model configs between HuggingFace and <a class="reference internal" href="expconfig.html#realhf.ReaLModelConfig" title="realhf.ReaLModelConfig"><code class="xref py py-class docutils literal notranslate"><span class="pre">realhf.ReaLModelConfig</span></code></a>.</p></li>
<li><p>Two functions to convert model state dicts between HuggingFace and ReaL, primarily involving key remapping.</p></li>
<li><p>Three functions specifying the names of parameters in the embedding layer, transformer blocks, and the output layer, respectively.</p></li>
</ul>
</section>
<section id="steps-to-support-a-new-huggingface-model">
<h3>Steps to Support a New HuggingFace Model<a class="headerlink" href="#steps-to-support-a-new-huggingface-model" title="Link to this heading">¶</a></h3>
<ul class="simple">
<li><p>Create a new model file under <code class="docutils literal notranslate"><span class="pre">api/from_hf/</span></code>.</p></li>
<li><p>Implement the required helper functions as described above.</p></li>
<li><p>Register the model with register_hf_family at the end of the file.</p></li>
<li><p>(Optional) Test the consistency of the implemented model with scripts in <code class="docutils literal notranslate"><span class="pre">tests/</span></code>.</p></li>
</ul>
<p>We acknowledge that the current configuration and implementation of <code class="docutils literal notranslate"><span class="pre">ReaLModel</span></code>
do not support all features of HuggingFace models,
such as MoE.
As a result, supporting a new HuggingFace model
often requires modifications to files in <code class="docutils literal notranslate"><span class="pre">impl/model/nn/</span></code>,
which can be a challenging experience for users unfamiliar with the code architecture.
If you have any questions or wish to request a new model feature,
please feel free to raise an issue on our GitHub repository.</p>
</section>
</section>
<section id="customizing-algorithms">
<h2>Customizing Algorithms<a class="headerlink" href="#customizing-algorithms" title="Link to this heading">¶</a></h2>
<section id="id2">
<h3>Overview<a class="headerlink" href="#id2" title="Link to this heading">¶</a></h3>
<p>In ReaL, algorithms are represented as dataflow graphs.
Each node in the graph corresponds to a model function call (MFC),
which can be a generate, inference, or train request applied to a
specific model (e.g., Actor or Critic).
The edges in the graph indicate data or
parameter version dependencies between nodes.</p>
<p>The following figure illustrates the dataflow graph of PPO:</p>
<img alt="Dataflow graph of RLHF." class="align-center" src="_images/rlhf_dfg.svg" /><p>A node is represented by a <a class="reference internal" href="expconfig.html#realhf.MFCDef" title="realhf.MFCDef"><code class="xref py py-class docutils literal notranslate"><span class="pre">realhf.MFCDef</span></code></a> object.
Each node has a <code class="docutils literal notranslate"><span class="pre">model_name</span></code> field and an <code class="docutils literal notranslate"><span class="pre">interface_type</span></code>
field, which specify what the node should conceptually do during execution.
The <code class="docutils literal notranslate"><span class="pre">interface_impl</span></code> field specifies the actual implementation of the model interface.</p>
<p>The interface class has the following signature:</p>
<dl class="py class">
<dt class="sig sig-object py" id="realhf.ModelInterface">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">realhf.</span></span><span class="sig-name descname"><span class="pre">ModelInterface</span></span><a class="headerlink" href="#realhf.ModelInterface" title="Link to this definition">¶</a></dt>
<dd><p>Interface for model training, evaluation, inference and generation.</p>
<dl class="py method">
<dt class="sig sig-object py" id="realhf.ModelInterface.evaluate">
<span class="sig-name descname"><span class="pre">evaluate</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">model</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">Model</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">eval_dataloader</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">DataLoader</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">Dict</span></span></span><a class="headerlink" href="#realhf.ModelInterface.evaluate" title="Link to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="realhf.ModelInterface.generate">
<span class="sig-name descname"><span class="pre">generate</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">model</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">Model</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">data</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference internal" href="expconfig.html#realhf.base.namedarray.NamedArray" title="realhf.base.namedarray.NamedArray"><span class="pre">NamedArray</span></a></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><a class="reference internal" href="expconfig.html#realhf.base.namedarray.NamedArray" title="realhf.base.namedarray.NamedArray"><span class="pre">NamedArray</span></a></span></span><a class="headerlink" href="#realhf.ModelInterface.generate" title="Link to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="realhf.ModelInterface.inference">
<span class="sig-name descname"><span class="pre">inference</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">model</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">Model</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">data</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference internal" href="expconfig.html#realhf.base.namedarray.NamedArray" title="realhf.base.namedarray.NamedArray"><span class="pre">NamedArray</span></a></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><a class="reference internal" href="expconfig.html#realhf.base.namedarray.NamedArray" title="realhf.base.namedarray.NamedArray"><span class="pre">NamedArray</span></a></span></span><a class="headerlink" href="#realhf.ModelInterface.inference" title="Link to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="realhf.ModelInterface.save">
<span class="sig-name descname"><span class="pre">save</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">model</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">Model</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">save_dir</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">str</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#realhf.ModelInterface.save" title="Link to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="realhf.ModelInterface.train_step">
<span class="sig-name descname"><span class="pre">train_step</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">model</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><span class="pre">Model</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">data</span></span><span class="p"><span class="pre">:</span></span><span class="w"> </span><span class="n"><a class="reference internal" href="expconfig.html#realhf.base.namedarray.NamedArray" title="realhf.base.namedarray.NamedArray"><span class="pre">NamedArray</span></a></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">Dict</span></span></span><a class="headerlink" href="#realhf.ModelInterface.train_step" title="Link to this definition">¶</a></dt>
<dd></dd></dl>

</dd></dl>

<p>During the execution of an MFC node,
the model identified by <code class="docutils literal notranslate"><span class="pre">model_name</span></code> is passed into this interface object,
along with the data specified in the MFC node.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Similar to datasets, model interfaces are registered and constructed by the system API. Please check <code class="docutils literal notranslate"><span class="pre">impl/model/interface/sft_interface.py</span></code> for an example. The <code class="docutils literal notranslate"><span class="pre">SFTInterface</span></code> is registered at the end of this file and constructed by <a class="reference internal" href="expconfig.html#realhf.SFTConfig" title="realhf.SFTConfig"><code class="xref py py-class docutils literal notranslate"><span class="pre">realhf.SFTConfig</span></code></a> (see the <code class="docutils literal notranslate"><span class="pre">rpcs</span></code> method).</p>
</div>
<p>Running algorithms in ReaL involves executing a large dataflow
graph that concatenates all the training iterations.
The <em>MasterWorker</em> monitors the state of this graph and
issues MFC requests to <em>ModelWorkers</em> once the dependencies are satisfied.</p>
</section>
<section id="example-a-customized-reward-function-for-ppo">
<h3>Example: A Customized Reward Function for PPO<a class="headerlink" href="#example-a-customized-reward-function-for-ppo" title="Link to this heading">¶</a></h3>
<p>In this example, we demonstrate how to use a customized reward model from HuggingFace in a PPO experiment when the model is not supported by <code class="docutils literal notranslate"><span class="pre">ReaLModel</span></code>.</p>
<p>The example code can be found in <code class="docutils literal notranslate"><span class="pre">examples/ppo_sentiment.py</span></code>, where we replace the trained reward model for sentiment generation with a BERT-like sentiment analysis model from HuggingFace.</p>
<p>First, we need to implement a new model interface class for our customized use:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@dataclasses</span><span class="o">.</span><span class="n">dataclass</span>
<span class="k">class</span> <span class="nc">SentimentScoringInterface</span><span class="p">(</span><span class="n">model_api</span><span class="o">.</span><span class="n">ModelInterface</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__post_init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">score_model</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">transformers</span><span class="o">.</span><span class="n">AutoModelForSequenceClassification</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span>
                <span class="s2">&quot;/path/to/score_model&quot;</span>
            <span class="p">)</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">score_model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">score_tokenizer</span> <span class="o">=</span> <span class="n">transformers</span><span class="o">.</span><span class="n">AutoTokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span>
            <span class="s2">&quot;/path/to/score_model&quot;</span>
        <span class="p">)</span>

    <span class="nd">@torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">inference</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">model_api</span><span class="o">.</span><span class="n">Model</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">NamedArray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NamedArray</span><span class="p">:</span>
        <span class="c1"># Re-tokenize the texts.</span>
        <span class="n">texts</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">batch_decode</span><span class="p">(</span>
            <span class="n">input_ids</span><span class="p">,</span> <span class="n">skip_special_tokens</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="n">encoding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">score_tokenizer</span><span class="p">(</span>
            <span class="n">texts</span><span class="p">,</span> <span class="n">return_tensors</span><span class="o">=</span><span class="s2">&quot;pt&quot;</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">truncation</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>

        <span class="c1"># Perform inference to get the score.</span>
        <span class="c1"># For IMDB, 0 is negative and 1 is positive. We record the logits of the positive class.</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">score_model</span><span class="p">(</span>
            <span class="n">input_ids</span><span class="o">=</span><span class="n">encoding</span><span class="p">[</span><span class="s2">&quot;input_ids&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">cuda</span><span class="p">(),</span>
            <span class="n">attention_mask</span><span class="o">=</span><span class="n">encoding</span><span class="p">[</span><span class="s2">&quot;attention_mask&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">cuda</span><span class="p">(),</span>
        <span class="p">)</span><span class="o">.</span><span class="n">logits</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">NamedArray</span><span class="p">(</span><span class="n">scores</span><span class="o">=</span><span class="n">scores</span><span class="p">)</span>
        <span class="n">res</span><span class="o">.</span><span class="n">register_metadata</span><span class="p">(</span><span class="o">**</span><span class="n">data</span><span class="o">.</span><span class="n">metadata</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>
</pre></div>
</div>
<p>Key points in this code:</p>
<ul class="simple">
<li><p>During interface initialization, we load a HuggingFace model and its tokenizer.</p></li>
<li><p>During inference, we re-tokenize the generated output from the Actor, compute the score, and return it.</p></li>
</ul>
<p>Now, we need to register this interface in the system API:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">model_api</span><span class="o">.</span><span class="n">register_interface</span><span class="p">(</span><span class="s2">&quot;sentiment_scoring&quot;</span><span class="p">,</span> <span class="n">SentimentScoringInterface</span><span class="p">)</span>
</pre></div>
</div>
<p>To use our customized interface implementation in PPO, we need to change the <code class="docutils literal notranslate"><span class="pre">interface_impl</span></code> field of the reward model in the MFC nodes of PPO:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyPPOConfig</span><span class="p">(</span><span class="n">PPOConfig</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">initial_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ExperimentConfig</span><span class="p">:</span>
        <span class="o">...</span>
        <span class="k">for</span> <span class="n">mw</span> <span class="ow">in</span> <span class="n">cfg</span><span class="o">.</span><span class="n">model_worker</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">mw</span><span class="o">.</span><span class="n">shards</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">model_name</span><span class="o">.</span><span class="n">role</span> <span class="o">==</span> <span class="s2">&quot;reward&quot;</span><span class="p">:</span>
                    <span class="c1"># Remove the original reward model because we are using a customized one.</span>
                    <span class="n">s</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">config_api</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span>
                        <span class="s2">&quot;tokenizer&quot;</span><span class="p">,</span>
                        <span class="n">args</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                            <span class="n">tokenizer_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rew</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
                        <span class="p">),</span>
                    <span class="p">)</span>
                    <span class="n">s</span><span class="o">.</span><span class="n">backend</span> <span class="o">=</span> <span class="n">config_api</span><span class="o">.</span><span class="n">ModelBackend</span><span class="p">(</span><span class="s2">&quot;null&quot;</span><span class="p">)</span>
        <span class="c1"># Change the MFC of Reward.</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">rpc</span> <span class="ow">in</span> <span class="n">cfg</span><span class="o">.</span><span class="n">model_rpcs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">rpc</span><span class="o">.</span><span class="n">model_name</span><span class="o">.</span><span class="n">role</span> <span class="o">==</span> <span class="s2">&quot;reward&quot;</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">inf_reward_rpc</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">model_rpcs</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">inf_reward_rpc</span><span class="o">.</span><span class="n">interface_impl</span> <span class="o">=</span> <span class="n">dfg</span><span class="o">.</span><span class="n">ModelInterface</span><span class="p">(</span><span class="s2">&quot;sentiment_scoring&quot;</span><span class="p">)</span>
        <span class="n">inf_reward_rpc</span><span class="o">.</span><span class="n">post_hooks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">return</span> <span class="n">cfg</span>
</pre></div>
</div>
<p>Don’t forget to register your customized experiment configuration so that ReaL can launch it with the quickstart command line options:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">register_quickstart_exp</span><span class="p">(</span><span class="s2">&quot;my-ppo&quot;</span><span class="p">,</span> <span class="n">MyPPOConfig</span><span class="p">)</span>
</pre></div>
</div>
<p>Finally, let’s run the customized experiment with the quickstart command:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>Note<span class="w"> </span>that<span class="w"> </span>we<span class="w"> </span>change<span class="w"> </span>the<span class="w"> </span>name<span class="w"> </span><span class="s2">&quot;ppo&quot;</span><span class="w"> </span>to<span class="w"> </span><span class="s2">&quot;my-ppo&quot;</span>
<span class="go">python3 -m realhf.apps.quickstart my-ppo \</span>
<span class="go">    experiment_name=sentiment-ppo \</span>
<span class="go">    trial_name=test \</span>
<span class="go">    ppo.kl_ctl=0.1 \</span>
<span class="go">    ppo.top_p=0.9 ppo.top_k=1000 \</span>
<span class="go">    ...</span>
</pre></div>
</div>
<p>This example is also applicable for scenarios where you want to use an external reward, such as a signal from a compiler or other online automatic evaluations.</p>
</section>
</section>
</section>

</article>
        <aside class="nftt-toc">
          
          <div class="mt-3 mb-1 my-lg-0 ps-xl-3 text-muted">
            <button class="btn btn-link link-dark p-lg-0 mb-2 mb-lg-0 text-decoration-none nftt-toc-toggle d-lg-none" type="button" data-bs-toggle="collapse" data-bs-target="#tocContents" aria-expanded="false" aria-controls="tocContents"
            >On this page <i class="ms-2 bi bi-chevron-expand"></i></button>
            <div class="title d-none d-lg-block">
              <i class="bi bi-file-earmark-text"></i>&nbsp;&nbsp;<span class="small">On this page</span>
            </div>
            <div class="collapse nftt-toc-collapse" id="tocContents">
              <nav id="TableOfContents">
                <ul>
<li><a class="reference internal" href="#">Customization</a><ul>
<li><a class="reference internal" href="#customizing-datasets">Customizing Datasets</a><ul>
<li><a class="reference internal" href="#overview">Overview</a></li>
<li><a class="reference internal" href="#how-dataset-configuration-is-parsed">How Dataset Configuration is Parsed</a></li>
<li><a class="reference internal" href="#steps-for-implementing-a-new-dataset">Steps for Implementing a New Dataset</a></li>
</ul>
</li>
<li><a class="reference internal" href="#customizing-models">Customizing Models</a><ul>
<li><a class="reference internal" href="#id1">Overview</a></li>
<li><a class="reference internal" href="#steps-to-support-a-new-huggingface-model">Steps to Support a New HuggingFace Model</a></li>
</ul>
</li>
<li><a class="reference internal" href="#customizing-algorithms">Customizing Algorithms</a><ul>
<li><a class="reference internal" href="#id2">Overview</a><ul>
<li><a class="reference internal" href="#realhf.ModelInterface"><code class="docutils literal notranslate"><span class="pre">ModelInterface</span></code></a><ul>
<li><a class="reference internal" href="#realhf.ModelInterface.evaluate"><code class="docutils literal notranslate"><span class="pre">ModelInterface.evaluate()</span></code></a></li>
<li><a class="reference internal" href="#realhf.ModelInterface.generate"><code class="docutils literal notranslate"><span class="pre">ModelInterface.generate()</span></code></a></li>
<li><a class="reference internal" href="#realhf.ModelInterface.inference"><code class="docutils literal notranslate"><span class="pre">ModelInterface.inference()</span></code></a></li>
<li><a class="reference internal" href="#realhf.ModelInterface.save"><code class="docutils literal notranslate"><span class="pre">ModelInterface.save()</span></code></a></li>
<li><a class="reference internal" href="#realhf.ModelInterface.train_step"><code class="docutils literal notranslate"><span class="pre">ModelInterface.train_step()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#example-a-customized-reward-function-for-ppo">Example: A Customized Reward Function for PPO</a></li>
</ul>
</li>
</ul>
</li>
</ul>

              </nav>
            </div>
          </div>
          
        </aside>
      </div>
    </div>

    <footer class="nftt-footer">
      <nav id="paginator" class="py-4" aria-label="Documentation navigation">
    <div class="container">
      <ul class="pagination justify-content-between mb-0"><li class="page-item">
            <a href="quickstart.html" class="d-flex px-5 align-items-end" rel="prev" aria-label="Previous page: Quickstart">
              <span class="prev-page"><i class="bi bi-caret-left"></i></span>
              <div class="d-flex flex-column">
                <span class="text-small text-start text-muted">Previous</span>
                <span class="underline">Quickstart</span>
              </div>
            </a>
          </li>
        <li class="page-item ms-auto">
            <a href="distributed.html" class="d-flex px-5 align-items-end" rel="next" aria-label="Next page: Set Up Distributed Experiments">
              <div class="d-flex flex-column">
                <span class="text-small text-end text-start text-muted">Next</span>
                <span class="underline">Set Up Distributed Experiments</span>
              </div>
              <span class="next-page"><i class="bi bi-caret-right"></i></span>
            </a>
          </li>
        
      </ul>
    </div>
  </nav>

      <div class="py-5 px-4 px-md-3">
  <div class="container">
    

    <div class="row">
      <div class="col-lg-12 text-center">
        <a class="brand-text d-inline-flex align-items-center mb-2 text-decoration-none" href="/" aria-label="Nefertiti-for-Sphinx">
          <span class="fs-6 fw-bold">ReaL</span>
        </a>
        
          <ul class="list-unstyled small text-muted">
            <li>2024, Wei Fu & Zhiyu Mei</li>
          </ul>
        
        
        <div class="built-with pt-2">
          Built with <a href="http://sphinx-doc.org">Sphinx 7.3.7</a> and <a href="https://github.com/danirus/sphinx-nefertiti">Nefertiti 0.3.4</a>
        </div>
        
      </div>
    </div>
  </div>
</div>
    </footer>
    <script src="_static/documentation_options.js?v=01f34227"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>

    <script type="text/javascript" src="_static/sphinx-nefertiti-0.3.4.min.js"></script>
    <script type="text/javascript" src="_static/bootstrap.bundle-0.3.4.min.js"></script>
    
    <script type="text/javascript" src="_static/doc_versions.js"></script>
  </body>
</html>